<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- saved from url=(0203)https://kulms.kanagawa-u.ac.jp/webclass/dqstn_answer.php?rnd=29011&set_contents_id=962a571d4c0e807ac6c73650305a376a&language=JAPANESE&content_mode=i&start_from_show_info=true&content_mode=q&acs_=fa18c563 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="Content-Style-Type" content="text/css">
    <meta http-equiv="Content-Script-Type" content="text/javascript">

    <link rel="stylesheet" type="text/css" href="./content.css">
<style type="text/css">
a{ text-decoration: underline; color: #1365b5;} </style>


    <style type="text/css">
        .answer-form-container{
            display:table;
        }
        .answer-form-container > *{
            display: table-cell;
            vertical-align: top;
        }

        .errorReport {
            background-color: #f2dede;
            color: #a94442;
            border: solid 1px #f2d3d3;
            border-radius: 4px;
            margin : 0em 10% 1em 10%;
            padding: 0.5em;
            text-align : center;
        }
        .warningReport {
            background-color: #eee;
            padding: 0.5em;
            margin : 0em 25% 1em 25%;
            text-align : center;
        }
        .infoReport {
            background-color: #eee;
            padding: 0.5em;
            margin : 0em 25% 1em 25%;
            text-align : center;
        }
        .dragenter {
            border-color: rgba(255,0,0, .3);
            background-color: rgba(255,0,0, .1);
        }

        [v-cloak] {
            display: none;
        }

    </style>
    <script type="text/javascript" src="./jquery-1.9.1.min.js.ダウンロード"></script>
    <script type="text/javascript" src="./interface.js.ダウンロード"></script>
    
    <script id="json-data" class="js-config" type="application/json">{"TOP_URL":"\/webclass\/","language":"JAPANESE","loading_image_url":"\/webclass\/images\/loading.gif","feature.message":true,"feature.information":1,"message-alert":false,"max_upload_file_size":1073741824,"contents_id":"962a571d4c0e807ac6c73650305a376a","branch_mode":false,"contents_end_datetime":"1687010459","deadlineRemainTime":165560,"extratime_mode":false,"do_contents.update_interval":60}</script>
    <script id="json-lang" class="js-message" type="application/json">{"Wait_until_uploading_finishes":"\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u304c\u7d42\u308f\u308b\u307e\u3067\u304a\u5f85\u3061\u304f\u3060\u3055\u3044\u3002","FILE_UPLOADING_FAILED":"\u30d5\u30a1\u30a4\u30eb\u306e\u53d7\u3051\u53d6\u308a\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002","PLEASE_TRY_AGAIN":"\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3057\u76f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002","Upload_file_size_limit_exceeded":"\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u306e\u4e0a\u9650 {0} \u3092\u8d85\u3048\u3066\u3044\u307e\u3059\u3002\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\uff1a{1}","Upload_file_size_is_zero":"\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u304c\uff10\u3067\u3059\u3002\u7a7a\u306e\u30d5\u30a1\u30a4\u30eb\u306f\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3067\u304d\u307e\u305b\u3093\u3002","not_allowed_file_type":"\u30ec\u30dd\u30fc\u30c8\u304c\u6307\u5b9a\u3055\u308c\u305f\u5f62\u5f0f\u3068\u7570\u306a\u308a\u307e\u3059\u3002\u6307\u5b9a\u3055\u308c\u305f\u5f62\u5f0f\u3067\u63d0\u51fa\u3057\u76f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002","Upload_file_type_is_invalid":"\u30d5\u30a1\u30a4\u30eb\u306e\u5f62\u5f0f\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002\u63d0\u51fa\u3057\u3088\u3046\u3068\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30d7\u30ea\u3067\u958b\u3044\u3066\u3001\u30d5\u30a1\u30a4\u30eb\u5185\u5bb9\u306b\u554f\u984c\u304c\u306a\u3044\u304b\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002","no_files_are_set":"\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002","Cancel_file":"\u30d5\u30a1\u30a4\u30eb\u9078\u629e\u3092\u89e3\u9664","DO_NOT_UPDATE_REPORT":"\u30ec\u30dd\u30fc\u30c8\u304c\u63d0\u51fa\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u518d\u63d0\u51fa\u3059\u308b\u3068\u3001\u524d\u56de\u306e\u30ec\u30dd\u30fc\u30c8\u304c\u7834\u68c4\u3055\u308c\u307e\u3059\u3002","There_are_some_invalid_inputs":"\u56de\u7b54\u6761\u4ef6\u3092\u6e80\u305f\u3057\u3066\u3044\u306a\u3044\u7b87\u6240\u304c\u3042\u308a\u307e\u3059\u3002","PAGE_UNLOAD_STRING":"\u4e0d\u6b63\u306a\u30da\u30fc\u30b8\u79fb\u52d5\u3092\u691c\u77e5\u3057\u307e\u3057\u305f\u3002\u3053\u306e\u307e\u307e\u79fb\u52d5\u3059\u308b\u3068\u6210\u7e3e\u30c7\u30fc\u30bf\u304c\u4fdd\u5b58\u3055\u308c\u306a\u304b\u3063\u305f\u308a\u3001\u6700\u60aa\u306e\u5834\u5408\u6210\u7e3e\u30c7\u30fc\u30bf\u3092\u7834\u58ca\u3057\u3066\u3057\u307e\u3046\u3053\u3068\u304c\u3042\u308a\u307e\u3059\u3002\\n\u3053\u306e\u6559\u6750\u3092\u5b89\u5168\u306b\u7d42\u4e86\u3059\u308b\u306b\u306f\u300c\u30ad\u30e3\u30f3\u30bb\u30eb\u300d\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u623b\u308a\u3001\u300c\u63a1\u70b9\u300d\u307e\u305f\u306f\u300c\u7d42\u4e86\u300d\u30dc\u30bf\u30f3\u3092\u62bc\u3057\u3066\u304f\u3060\u3055\u3044\u3002","CURRENT_CHAR_NUM_1":"\u73fe\u5728","CURRENT_CHAR_NUM_2":"\u6587\u5b57\u3002","TEXT_TOO_MANY_CHARACTERS":"\u5b57\u6570\u5236\u9650\u3092\u8d85\u3048\u307e\u3057\u305f\u3002","TEXT_TOO_FEW_CHARACTERS":"\u5b57\u6570\u304c\u8db3\u308a\u307e\u305b\u3093\u3002","TEXT_LENGTH_REQUIRE_1":"\u5b57\u6570\u304c\u8db3\u308a\u307e\u305b\u3093\u3002 \u3042\u3068","TEXT_LENGTH_REQUIRE_2":"\u6587\u5b57\u5fc5\u8981\u3067\u3059\u3002","TEXT_LENGTH_OVER_1":"\u5b57\u6570\u5236\u9650\u3092\u8d85\u3048\u307e\u3057\u305f\u3002 ","TEXT_LENGTH_OVER_2":"\u6587\u5b57\u307e\u3067\u5165\u529b\u3067\u304d\u307e\u3059\u3002","TEXT_LENGTH_REMAIN_1":"\u3042\u3068","TEXT_LENGTH_REMAIN_2":"\u6587\u5b57\u3002","TEXT_LENGTH_IS_EXCEEDED":"%d \u6587\u5b57\u8d85\u904e\u3057\u3066\u3044\u307e\u3059\u3002","TEXT_LENGTH_IS_SHORT":"%d \u6587\u5b57\u4e0d\u8db3\u3057\u3066\u3044\u307e\u3059\u3002","CONFIRM_BRANCH_ANSWER_BACK":"\u524d\u306e\u8a2d\u554f\u306b\u623b\u3063\u3066\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f\n\n\u3053\u306e\u6559\u6750\u306f\u56de\u7b54\u306b\u5fdc\u3058\u3066\u9032\u3080\u8a2d\u554f\u304c\u5207\u308a\u66ff\u308f\u308b\u5f62\u5f0f\u306e\u305f\u3081\u3001\u524d\u306e\u8a2d\u554f\u306b\u623b\u308b\u3068\u4eca\u306e\u8a2d\u554f\u306e\u56de\u7b54\u306f\u524a\u9664\u3055\u308c\u307e\u3059\u3002","MINUTE":"\u5206","SECOND":"\u79d2","MINUTE_SHORT":"\u5206","SECOND_SHORT":"\u79d2"}</script>

    <script type="text/javascript">
        var paramData;
        var langs;
        function loadConfigs() {
            var elem = document.getElementById("json-data");
            var data = JSON.parse(elem.textContent);
            paramData = data;

            var elem = document.getElementById("json-lang");
            var data = JSON.parse(elem.textContent);
            langs = data;
        }

        function __(label) {
            var langData = {
                'PAGE_UNLOAD_STRING' : '不正なページ移動を検知しました。このまま移動すると成績データが保存されなかったり、最悪の場合成績データを破壊してしまうことがあります。\nこの教材を安全に終了するには「キャンセル」ボタンを押して戻り、「採点」または「終了」ボタンを押してください。',
                'CURRENT_CHAR_NUM_1' : '現在',
                'CURRENT_CHAR_NUM_2' : '文字。',
                'TEXT_TOO_MANY_CHARACTERS' : '字数制限を超えました。',
                'TEXT_TOO_FEW_CHARACTERS' : '字数が足りません。',
                'TEXT_LENGTH_IS_EXCEEDED' : '%d 文字超過。',
                'TEXT_LENGTH_IS_SHORT' : '%d 文字不足。',
                'TEXT_LENGTH_REQUIRE_1' : '字数が足りません。 あと',
                'TEXT_LENGTH_REQUIRE_2' : '文字必要です。',
                'TEXT_LENGTH_OVER_1' : '字数制限を超えました。 ',
                'TEXT_LENGTH_OVER_2' : '文字まで入力できます。',
                'TEXT_LENGTH_REMAIN_1' : 'あと',
                'TEXT_LENGTH_REMAIN_2' : '文字。',
                'TEXT_LENGTH_FIX_SUGGEST' : '保存するには字数制限内に収まるように直してください。'
            }
            if(langData[label]) {
                return langData[label];
            } else if (langs[label]) {
                return langs[label];
            } else {
                return label;
            }
        }

        /**
 * テスト画面で使うjavascript
 */

window.onbeforeunload = function(event){
    if (document.answer_form) {
        if (document.answer_form.sendCmd.value == '') {
            event = event || window.event;
            event.returnValue = __('PAGE_UNLOAD_STRING');
        }
    }
}


function calcTextLength (text) {
  return text.replace(/\r\n/gm,'\n').length;
}

function getTextLimitByDom (id) {
  var min_length = parseInt($('#text_'+ id).attr('data-min-length'));
  var max_length = parseInt($('#text_'+ id).attr('data-max-length'));

  return {
    min_length: min_length,
    max_length: max_length
  };
}

function validateText (length, textLimit)
{
  var returnFalse = function(reason) {
    return {
      valid : false,
      invalid_reason: reason
    };
  };
  var returnTrue = function() {
    return {
      valid : true,
      invalid_reason: ''
    }
  };

  if (length > textLimit.max_length && textLimit.max_length > 0) {
    return returnFalse(__('TEXT_TOO_MANY_CHARACTERS'));
  }

  if(length < textLimit.min_length && textLimit.min_length > 0) {
    return returnFalse(__('TEXT_TOO_FEW_CHARACTERS'));
  }

  return returnTrue();
}

function validateForm () {
  var valid = true;

  var els = document.getElementsByClassName('inputcounter');
  for (var i = 0; i < els.length; i++) {
    var fieldId = els[i].name;
    if ($('#text_' + fieldId).val().length > 0) {
      var textLimit = getTextLimitByDom(fieldId);
      var length = calcTextLength($('#text_' + fieldId).val());
      updateTextLength(fieldId);
      var textValidationResult = validateText(length, textLimit);
      if (!textValidationResult.valid) {
        valid = false;
      }
    }
  }

  return valid;
}


function submitCheckText(pno) {
  if (document.answer_form && document.answer_form.action) {
    document.answer_form.action = '#id_question_' + pno;
  }
  safeSubmit('checkText');
}

function sendReport(reportName, overwrite) {
  if (overwrite) {
    if (!window.confirm('既にレポートファイルが登録されています。このまま続行すると前に提出したファイルがキャンセル(上書き)されますがよろしいですか？')) {
      clearFileField('file' + reportName);
      return false;
    }
  }
  if (safeSubmit('sendReport')) {
    loadingReport(reportName);
  }
}
function clearFileField(id) {
  var area = document.getElementById(id);
  var temp = area.innerHTML;
  area.innerHTML = temp;
}
function loadingReport(reportName){
  document.getElementById('loading' + reportName).style.display = 'block';
  document.getElementById('submitReport' + reportName).style.display    = 'none';
}

/**
 * テキストフィールドの文字数カウンターを更新する
 * @param id
 */
function updateTextLength(id) {
  var text = $('#text_' + id).val().replace(/\r\n/gm, '\n');
  var min_length = parseInt($('#text_' + id).attr('data-min-length'));
  var max_length = parseInt($('#text_' + id).attr('data-max-length'));
  var length = text.length;

  var modeClass = 'textStatusFair';
  if (length < min_length && min_length > 0 && length > 0) {
    modeClass = 'textStatusShort';
  } else if (length > max_length) {
    modeClass = 'textStatusLong';
  }

  $('#text_' + id + '_info .message1')
    .text(__('CURRENT_CHAR_NUM_1') + ' ' + length + ' ' + __('CURRENT_CHAR_NUM_2'))
    .removeClass('textStatusShort')
    .removeClass('textStatusLong');

  if (modeClass == 'textStatusShort') {
    $('#text_' + id + '_info .message2')
      .text(__('TEXT_LENGTH_IS_SHORT').replace('%d', (min_length - length))+ ' ' + __('TEXT_LENGTH_FIX_SUGGEST'))
      .addClass('red_moji')
      .removeClass('blue_moji');
  } else if (modeClass == 'textStatusLong') {
    $('#text_' + id + '_info .message2')
      .text(__('TEXT_LENGTH_IS_EXCEEDED').replace('%d', (length - max_length))+ ' ' + __('TEXT_LENGTH_FIX_SUGGEST'))
      .addClass('red_moji')
      .removeClass('blue_moji');
  } else {
    $('#text_' + id + '_info .message2')
      .text(__('TEXT_LENGTH_REMAIN_1') + ' ' + (max_length - length) + '' + __('TEXT_LENGTH_REMAIN_2'))
      .addClass('blue_moji')
      .removeClass('red_moji');
  }

  if (modeClass !== 'textStatusFair') {
    $('#saveButton_' + id).prop('disabled', true);
  } else {
    $('#saveButton_' + id).prop('disabled', false);
  }
}

$(document).ready(function(){
    $(".TabEnable").EnableTabs();

    if(multiLanguageScreenKeyboard) {
        $('.LangKeyboad').attachScreenKeyboard();
    }

  var els = document.getElementsByClassName('inputcounter');
  for (var i = 0; i < els.length; i++) {
    updateTextLength(els[i].name);

    var handler = function (e) {
      updateTextLength(e.target.name);
    };
    els[i].addEventListener('keyup', handler);
    els[i].addEventListener('paste', handler);
    els[i].addEventListener('change', handler);
  }

    $('input[type="text"]').keypress(function(e){
        if (!e) var e = window.event;

        // trap enter key
        if(e.keyCode == 13){
            // disable browser default action (form submit)
            e.preventDefault();

            // toggle focus
            var name = $(this).attr('name');
            var n = $('input[name="'+name+'"]').size();
            var index = null;
            for(var i=0; i < n; i++) {
                if($('input[name="'+name+'"]')[i] == this) {
                    index = [i];
                    break;
                }
            }
            if (index != null) {
                if (index == n-1) {
                    index = 0;
                } else {
                    index ++;
                }
                $($('input[name="'+name+'"]')[index]).focus();
            }

            return false;
        }
    });
});

var WC_QuestionClient = function() {
    this.commitValidation = true;
    this.reportUploadValidation = true;
    this.textUploadValidation = true;

    this.textHardMaximum = 20000;
    this.reportUploadingStates = {};
    this.reportUploaderBussy = false;
};

WC_QuestionClient.prototype.init = function() {
    var clientObject = this;

    window.onbeforeunload = function(event){
        if (clientObject.isSubmitting()) {
            return;
        }
        event.returnValue = clientObject.t('PAGE_UNLOAD_STRING');
    };

    $('.textStyle .inputcounter')
        .on('change', function() {
            clientObject.textChangeHandler(this, clientObject);
        })
        .on('keyup', function() {
            clientObject.textChangeHandler(this, clientObject);
        })
        .on('paste', function() {
            clientObject.textChangeHandler(this, clientObject);
        })
        .each(function() {
            clientObject.textChangeHandler(this, clientObject);
        });
}

WC_QuestionClient.prototype.timeUp = function() {
    this.commit('timeout');
}


/**
 * get localed string
 *
 * @param label
 * @returns {*}
 */
WC_QuestionClient.prototype.t = function(label) {
    if (label in langs) {
        return langs[label];
    }

    return label;
}


/**
 * Request some action with submitting form data.
 * Actual result depends on 'cmd' of action request.
 *
 * @param cmd
 * @param data
 */
WC_QuestionClient.prototype.commit = function(cmd, data) {
    if (this.isSubmitting()) {
        return ;
    }

    // Do not skip this validation.
    // If your form has some blockers and you have to send your form,
    // remove blockers before you call commit();
    if (cmd === 'timeout') {
        //this.forceSanitizeForm();
    } else {
        if (this.commitValidation && !this.validateForm()) {
            this.showErrorMessage(this.t('There_are_some_invalid_inputs'));
            return;
        }
        if (this.isFileUploading()) {
            return;
        }
    }

    $.mobile.loading('show', {
        text: this.t('Wait_until_uploading_finishes'),
        textVisible: true,
        textonly: false
    });

    this.submit(cmd, data);
};

/**
 *
 * @param cmd
 */
WC_QuestionClient.prototype.submit = function(cmd, data) {
    document.QuestionForm['QstnSession[cmd]'].value = cmd;
    if (data == undefined) {
        document.QuestionForm['QstnSession[cmdData]'].value = '';
    } else {
        document.QuestionForm['QstnSession[cmdData]'].value = data;
    }
    document.QuestionForm.submit();
}

/**
 *
 * @returns {boolean}
 */
WC_QuestionClient.prototype.isSubmitting = function() {
    return !(document.QuestionForm['QstnSession[cmd]'].value == '');
}

WC_QuestionClient.prototype.forceSanitizeForm = function() {
    var clientObject = this;
    var valid = true;
    $('fieldset.reportStyle').each(function() {
        if ($(this).find('input[type=file]').length) {
            var file = $(this).find('input[type=file]').prop('files')[0];
            if (file != null) {
                var fieldId = $(this).attr('id');
                var reportFileLimit = clientObject.getReportFileLimitByDom(fieldId);
                var fileValidationResult = clientObject.validateReportFile(file, reportFileLimit);
                if (!fileValidationResult.valid) {
                    clientObject.showReportNotice(fieldId, fileValidationResult.invalid_reason);
                    // force drop off invalid file to protect system.
                    clientObject.cancelReportInput(fieldId);
                    valid = false;
                } else {
                    clientObject.hideReportNotice(fieldId);
                }
            }
        }
    });

    $('.textStyle').each(function() {
        if ($(this).find('textarea').val().length > 0) {
            var fieldId = $(this).attr('id');
            var textLimit = clientObject.getTextLimitByDom(fieldId);
            var length = clientObject.calcTextLength($(this).find('textarea').val());
            if (length > this.textHardMaximum) {
                clientObject.shortenTextToMaximumLength(fieldId, this.textHardMaximum);
                valid = false;
            }
            clientObject.updateTextLengthCounter(fieldId);
        }
    });

    return valid;
}

/**
 * Check form for application blockers
 *
 * @returns {boolean}
 */
WC_QuestionClient.prototype.validateForm = function () {
    var clientObject = this;
    var valid = true;
    $('fieldset.reportStyle').each(function() {
        if ($(this).find('input[type=file]').length) {
            var file = $(this).find('input[type=file]').prop('files')[0];
            if (file != null) {
                var fieldId = $(this).attr('id');
                var reportFileLimit = clientObject.getReportFileLimitByDom(fieldId);
                var fileValidationResult = clientObject.validateReportFile(file, reportFileLimit);
                if (!fileValidationResult.valid) {
                    clientObject.showReportNotice(fieldId, fileValidationResult.invalid_reason);
                    valid = false;
                } else {
                    clientObject.hideReportNotice(fieldId);
                }
            }
        }
    });

    $('.textStyle').each(function() {
        /*
        if ($(this).find('textarea').val().length > 0) {
            var fieldId = $(this).attr('id');
            var textLimit = clientObject.getTextLimitByDom(fieldId);
            var length = clientObject.calcTextLength($(this).find('textarea').val());
            clientObject.updateTextLengthCounter(fieldId);
            var textValidationResult = clientObject.validateText(length, textLimit);
            if (!textValidationResult.valid) {
                valid = false;
            }
        }
        */
    });

    return valid;
}

/**
 *
 * @param page
 * @returns {undefined}
 */
WC_QuestionClient.prototype.restart = function(page) {
    return this.commit('restart');
};

/**
 * Request finish and close current question material.
 *
 */
WC_QuestionClient.prototype.finish = function() {
    return this.commit('finish');
};

WC_QuestionClient.prototype.index = function() {
    return this.commit('index');
};
WC_QuestionClient.prototype.bookmark = function() {
    return this.commit('bookmark');
};
WC_QuestionClient.prototype.prevPage = function() {
    if (paramData.branch_mode) {
        if (!window.confirm(__('CONFIRM_BRANCH_ANSWER_BACK'))) {
            return;
        }
    }
    return this.commit('prevPage');
};
WC_QuestionClient.prototype.nextPage = function() {
    return this.commit('nextPage');
};
WC_QuestionClient.prototype.movePage = function(page) {
    return this.commit('movePage', page);
};
WC_QuestionClient.prototype.check = function(page) {
    return this.commit('check');
};

WC_QuestionClient.prototype.checkTextInput = function() {
    return this.commit('checkTextInput');
}

WC_QuestionClient.prototype.showErrorMessage = function(msg) {
    alert(msg);
}

WC_QuestionClient.prototype.showInfoMessage = function(msg) {

}

/**
 * テキストフィールドの文字数カウンターを更新する
 */
WC_QuestionClient.prototype.textChangeHandler = function (eventElem, questionClient) {
    var fieldId = $(eventElem).attr('data-field-id');
    questionClient.updateTextLengthCounter(fieldId);
}

WC_QuestionClient.prototype.saveText = function(fieldId) {
    var text = $('#'+ fieldId + ' textarea').val();
    this.updateTextLengthCounter(fieldId);

    if (this.textUploadValidation) {
        if (text.length > 0) {
            var textLimit = this.getTextLimitByDom(fieldId);
            var length = this.calcTextLength(text);

            var textValidationResult = this.validateText(length, textLimit);
            if (!textValidationResult.valid) {
                this.showErrorMessage(textValidationResult.invalid_reason);
                return;
            }
        }
    }

    return this.restart();
};

WC_QuestionClient.prototype.calcTextLength = function (text) {
    return text.replace(/\r\n/gm,'\n').length;
}

WC_QuestionClient.prototype.getTextLimitByDom = function(fieldId) {
    var min_length = parseInt($('#'+ fieldId + ' textarea').attr('data-min-length'));
    var max_length = parseInt($('#'+ fieldId + ' textarea').attr('data-max-length'));

    return {
        min_length: min_length,
        max_length: max_length
    };
}

WC_QuestionClient.prototype.validateText = function(length, textLimit)
{
    var returnFalse = function(reason) {
        return {
            valid : false,
            invalid_reason: reason
        };
    };
    var returnTrue = function() {
        return {
            valid : true,
            invalid_reason: ''
        }
    };

    if (length > textLimit.max_length && textLimit.max_length > 0) {
       return returnFalse(this.t('TEXT_TOO_MANY_CHARACTERS'));
    }

    if(length < textLimit.min_length && textLimit.min_length > 0) {
        return returnFalse(this.t('TEXT_TOO_FEW_CHARACTERS'));
    }

    return returnTrue();
}

WC_QuestionClient.prototype.updateTextLengthCounter = function(fieldId) {
    var text = $('#'+ fieldId + ' textarea').val();
    var min_length = parseInt($('#'+ fieldId + ' textarea').attr('data-min-length'));
    var max_length = parseInt($('#'+ fieldId + ' textarea').attr('data-max-length'));
    var length = text.replace(/\r\n/gm,'\n').length;

    var modeClass = 'textStatusFair';
    if (length < min_length && min_length > 0 && length > 0) {
        modeClass = 'textStatusShort';
    } else if (length > max_length) {
        modeClass = 'textStatusLong';
    }


    $('#'+fieldId + ' .textLengthInfo .message1').text(this.t('CURRENT_CHAR_NUM_1') + ' '+ length + ' '+ this.t('CURRENT_CHAR_NUM_2'));
    $('#'+fieldId + ' .textLengthInfo .message1').css('color', 'black');

    if (modeClass == 'textStatusShort') {
        $('#'+fieldId + ' .textLengthInfo .message2')
            .text(this.t('TEXT_LENGTH_IS_SHORT').replace('%d', (min_length - length))+ ' ' + this.t('TEXT_LENGTH_FIX_SUGGEST'))
            .css('color', 'red');
        $('#saveButton_'+fieldId).addClass('ui-disabled');
    } else if (modeClass == 'textStatusLong') {
        $('#'+fieldId + ' .textLengthInfo .message2')
            .text(this.t('TEXT_LENGTH_IS_EXCEEDED').replace('%d', (length - max_length))+ ' ' + this.t('TEXT_LENGTH_FIX_SUGGEST'))
            .css('color', 'red');
        $('#saveButton_'+fieldId).addClass('ui-disabled');
    } else {
        $('#'+fieldId + ' .textLengthInfo .message2')
            .text(this.t('TEXT_LENGTH_REMAIN_1') + ' ' + (max_length - length) + ' ' + this.t('TEXT_LENGTH_REMAIN_2'))
            .css('color', 'black');
        $('#saveButton_'+fieldId).removeClass('ui-disabled');
    }
}

/**
 *
 * @param fieldId
 * @param max_length
 */
WC_QuestionClient.prototype.shortenTextToMaximumLength = function (fieldId, max_length) {
    var text = $('#'+ fieldId + ' textarea').val();
    if (max_length === undefined || max_length === null ||  max_length === 0) {
        max_length = parseInt($('#'+ fieldId + ' textarea').attr('data-max-length'));
    }
    var length = text.replace(/\r\n/gm,'\n').length;

    if (length > max_length) {
        text = text.substr(0, max_length);
        $('#'+ fieldId + ' textarea').val(text);
    }
}


/**
 * When report file is changed, validate file user wants to upload.
 *
 */
WC_QuestionClient.prototype.reportFileChangeHandler = function(eventElem, questionClient) {
    var fieldId = $(eventElem).attr('data-field-id');
    questionClient.hideReportNotice(fieldId);
    if ($('#'+fieldId).find('input[type=file]').length) {
        var file = $('#' + fieldId).find('input[type=file]').prop('files')[0];
        if (file != null) {
            var reportFileLimit = questionClient.getReportFileLimitByDom(fieldId);
            var fileValidationResult = questionClient.validateReportFile(file, reportFileLimit);
            if (!fileValidationResult.valid) {
                questionClient.showErrorMessage(fileValidationResult.invalid_reason);
                questionClient.showReportNotice(fieldId, fileValidationResult.invalid_reason);
            }
        }
    }
}

/**
 *
 * @param fieldId
 * @returns {boolean|*}
 */
WC_QuestionClient.prototype.uploadReport = function(fieldId)
{
    this.hideReportNotice(fieldId);
    if (this.reportUploadValidation) {
        if ($('#'+fieldId).find('input[type=file]').length) {
            var file = $('#'+fieldId).find('input[type=file]').prop('files')[0];
            if (file != null) {
                var reportFileLimit = this.getReportFileLimitByDom(fieldId);
                var fileValidationResult = this.validateReportFile(file, reportFileLimit);
                if (!fileValidationResult.valid) {
                    this.showErrorMessage(fileValidationResult.invalid_reason);
                    this.showReportNotice(fieldId, fileValidationResult.invalid_reason);
                    return;
                }
            } else {
                // file not set
                this.showErrorMessage(this.t('no_files_are_set'));
                return;
            }
        }
    }

    return this.restart();
};

WC_QuestionClient.prototype.getReportFileLimitByDom = function(fieldId) {
    var max_size = parseInt($('#' + fieldId).attr('data-size-limit'));
    var limit_type = $('#'+fieldId).attr('data-type-limit');
    var allowedTypes = [];
    if (limit_type.length > 0) {
        allowedTypes = limit_type.split(',');
    }

    return {
        min_size: 1,
        max_size: max_size,
        allowed_types: allowedTypes
    };
}

WC_QuestionClient.prototype.showReportNotice = function(fieldId, msg) {
    var reportFileNoticeBlock = $('#'+fieldId + ' .reportFileNotice');
    reportFileNoticeBlock.html('<p><span style="color:red; font-weight: bold;">' + msg + '</span>' +
        "<input type=\"button\" value=\"" + this.t('Cancel_file') + "\" class='CancelFileChoiceButton' onclick=\"return QuestionClient.cancelReportInput('" +
        fieldId + "')\">" +
    '</p>');
}

WC_QuestionClient.prototype.hideReportNotice = function(fieldId) {
    $('#'+fieldId + ' .reportFileNotice').html('');
}

/**
 * cancel file choice on file input form.
 * Generally, file input form can not be canceled after some files are set while file can be changed.
 *
 * @param fieldId
 */
WC_QuestionClient.prototype.cancelReportInput = function(fieldId) {
    // jquery mobile extends dom structure.

    var outer = $('#'+fieldId+'_outer');
    if (outer.find('input[type=file]').length) {
        var file = outer.find('input[type=file]');
        var parent = file.parent();
        var fileClasses = file.attr('class');
        var fileName = file.attr('name');
        file.appendTo($('<div>'));

        var clientObject = this;
        var newFileInput = $('<input type=\"file\" name = \"' + fileName + '\" data-field-id="' + fieldId + '" class="' + fileClasses + '">');
        /*
         // this is blocked by cromium + GoogleDrive problem
        .on('change', function(){
            clientObject.reportFileChangeHandler(this, clientObject);
        });
         */
        parent.append(newFileInput);
        $('#'+fieldId + ' .reportFileNotice').html('');
    }
}

WC_QuestionClient.prototype.validateReportFile = function(fileStruct, reportFileLimit)
{
    var returnFalse = function(reason) {
        return {
            valid : false,
            invalid_reason: reason
        };
    };
    var returnTrue = function() {
        return {
            valid : true,
            invalid_reason: ''
        }
    };

    if (fileStruct.size > reportFileLimit.max_size) {
        return returnFalse(formatStr(this.t('Upload_file_size_limit_exceeded'), formatFileSize(reportFileLimit.max_size), formatFileSize(fileStruct.size)));
    }
    if (fileStruct.size < reportFileLimit.min_size) {
        return returnFalse(this.t('Upload_file_size_is_zero'));
    }

    if (reportFileLimit.allowed_types.length > 0) {
        if (!checkExtension(reportFileLimit.allowed_types, fileStruct.name)) {
            return returnFalse(this.t('not_allowed_file_type'));
        }
    }
    var ext = getLastExtensionFromFileName(fileStruct.name);
    switch (ext) {
        case 'docx':
        case 'xlsx':
        case 'pptx':
        case 'doc':
        case 'xls':
        case 'ppt':
            // Uploaded files from onedrive with android browser contain only link urls with original file name.
            // This faking occur users and authors confusion.
            // To reject faking file, file size is one clue. Open document office files costs more than 1kb usually.
            if (fileStruct.size < 1000) {
                return returnFalse(this.t('Upload_file_type_is_invalid'));
            }
            break;
    }

    return returnTrue();
}

WC_QuestionClient.prototype.asyncUploadFile = function (qnum, file, callbacks) {
    // フォームデータを取得
    var formdata = new FormData();
    formdata.append('set_contents_id', paramData.contents_id);
    formdata.append('question_no', qnum);
    formdata.append('upload_file', file);

    var clientObject = this;
    this.reportUploadingStates[qnum] = true;

    // テスト教材はもともと非同期アクセスに対応していないので、アップロード処理は実際には１スレッドにする。
    // アップロードリクエストをキューイングする方が良い。
    asyncUploader = function(qnum, formdata, callbacks) {
        if (!clientObject.reportUploaderBussy) {
            clientObject.reportUploaderBussy = true;
            $.ajax({
                url: paramData.TOP_URL + 'mbl.php/questions/api?api=upload&set_contents_id='+paramData.contents_id,
                type: "POST",
                data: formdata,
                cache: false,
                contentType: false,
                processData: false,
                dataType: 'json'
            })
                .done(function (data, textStatus, jqXHR) {
                    if (data.status === 'OK') {
                        if (callbacks && callbacks.done) {
                            callbacks.done(data);
                        }
                    } else if (callbacks && callbacks.fail) {
                        if (data.message) {
                            callbacks.fail(data.message);
                        } else{
                            callbacks.fail('unknown error');
                        }
                    }
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    if (callbacks && callbacks.fail) {
                        callbacks.fail('request failed : ' + textStatus);
                    }
                })
                .always(function (data) {
                    clientObject.reportUploadingStates[qnum] = false;
                    clientObject.reportUploaderBussy = false;
                    if (callbacks && callbacks.always) {
                        callbacks.always();
                    }
                });
        } else {
            setTimeout(function() {
                asyncUploader(qnum, formdata, callbacks);
            }, 300);
        }
    }
    asyncUploader(qnum, formdata, callbacks);
};

WC_QuestionClient.prototype.isFileUploading = function () {
    for(qnum in this.reportUploadingStates) {
        if (this.reportUploadingStates[qnum]) {
            return true;
        }
    }
    return false;
};


function radioClear(num) {
    var itemLength = 0;
    if (document.QuestionForm['QuestionAnswer['+num+'][value]']) {
        itemLength = document.QuestionForm['QuestionAnswer['+num+'][value]'].length;
    }
    for (i = 0; i < itemLength; i++) {
        document.QuestionForm['QuestionAnswer['+num+'][value]'][i].checked = false;
    }
    $(document.QuestionForm['QuestionAnswer['+num+'][value]']).checkboxradio("refresh");
}
function textClear(num) {
    if (document.QuestionForm && document.QuestionForm['QuestionAnswer['+num+'][text]'] != null) {
        document.QuestionForm['QuestionAnswer['+num+'][text]'].value = '';
    }
}

/**
 * フォーマット関数
 * formatStr("string {0} and {1}", "ValA", "ValB")のように渡して使います。
 */
function formatStr(fmt, a)
{
    var rep_fn = undefined;

    if (typeof a == "object") {
        rep_fn = function(m, k) { return a[ k ]; }
    }
    else {
        var args = arguments;
        rep_fn = function(m, k) { return args[ parseInt(k)+1 ]; }
    }

    return fmt.replace( /\{(\w+)\}/g, rep_fn);
}

function formatFileSize(bytes) {
    if (typeof bytes !== 'number') {
        return '';
    }
    var Mega = 1024 * 1024;
    var Giga = Mega * 1024;
    if (bytes >= Giga) {
        return (bytes / Giga).toFixed(2) + ' GB';
    }
    if (bytes >= Mega) {
        return (bytes / Mega).toFixed(2) + ' MB';
    }
    return (bytes / 1024).toFixed(2) + ' KB';
}

/**
 *
 * @param acceptableFileType (Word, Excel, PowerPoint, Text, PDF)
 * @param fileName
 * @return boolean
 */
function checkExtension(acceptableFileType, fileName)
{
    fileType = getReportFileType(fileName);
    if (acceptableFileType.length > 0 && fileType.length > 0) {
        if (acceptableFileType.indexOf(fileType) >= 0) {
            return true;
        }
    }
    return false;
}

function getLastExtensionFromFileName(fileName)
{
    var ext  = '';
    var dotPos = fileName.lastIndexOf('.');
    if (dotPos > 0) {
        ext = fileName.substr(dotPos+1).toLowerCase();
    }

    return ext;
}

function getReportFileType(fileName)
{
    var ext  = getLastExtensionFromFileName(fileName);

    var extension_array = {
        "doc"  : "Word",
        "docx" : "Word",
        "docm" : "Word",
        "xls"  : "Excel",
        "xlsx" : "Excel",
        "xlsm" : "Excel",
        "ppt"  : "PowerPoint",
        "pptx" : "PowerPoint",
        "pptm" : "PowerPoint",
        "txt"  : "Text",
        "pdf"  : "PDF"
    };

    if (ext in extension_array) {
        return extension_array[ext];
    }

    return "";
}

        var QuestionClient = new WC_QuestionClient();
        $(document).ready(function() {
            loadConfigs();
        });

        	function filedownload(openurl) {
		w = window.open(openurl, "download",
				"toolbar=no,location=no,directories=no,status=yes,menubar=no,scrollbars=yes,resizable=yes,width=320,height=250");
		w.window.focus();
	}

        function formchanged() {
            parent.button.location.replace(document.answer_form.button_url.value);
            parent.question.location.replace(document.answer_form.question_url.value);
        }
        function formchanged_qa() {
            parent.button.location.replace(document.answer_form.button_url.value);
            parent.question.location.replace(document.answer_form.question_url.value);
            parent.description.location.replace(document.answer_form.description_url.value);
        }

        var validationEnabled = false;
        var submitting = false;
        function safeSubmit(cmd) {
            if (submitting) {
                return false;
            }

            if (cmd === 'timeup') {

            } else {
                if (validationEnabled && !validateForm()) {
                    showErrorMessage(__('There_are_some_invalid_inputs'));
                    return false;
                }

                if (QuestionClient.isFileUploading()) {
                    return false;
                }

                showLoadingIcon();
            }

            submitting = true;
            document.answer_form.sendCmd.value = cmd;
            document.answer_form.submit();
            return true;
        }

        function showLoadingIcon()
        {

        }

        function showErrorMessage(msg)
        {
            alert(msg);
        }

        $(function() {
            $(document.answer_form).on('submit', function(event) {
                if (QuestionClient.isFileUploading()) {
                    event.stopPropagation();
                    event.preventDefault();
                    return false;
                }
                if (submitting) {
                    event.stopPropagation();
                    event.preventDefault();
                    return false;
                }
                submitting = true;
            })
        });

        var multiLanguageScreenKeyboard = false;
        
        function radioClear(num) {
            for(i = 0; i < document.answer_form.radio.length; i++) {
                document.answer_form.radio[i].checked = false;
            }
        }
        function textClear(num) {
            if (document.answer_form.text != null) {
                document.answer_form.text.value = "";
            }
        }

        function timeup() {
            // PHP 側のタイマー処理と微妙にズレが起こる時があるので、あえて少し遅らせる。
            setTimeout(function() {
                safeSubmit('timeup');
            }, 1000);
        }
        function gradeAndClose() {
            safeSubmit('grade');
        }
        function bookmarkAndClose() {
            safeSubmit('bookmark');
        }
        function checkAnswer() {
            safeSubmit('check');
        }

        function backToQuestion() {
            safeSubmit('back');
        }

        function setPage(page) {
            if (document.answer_form.page) {
                document.answer_form.page.value = page;
            }
            if (safeSubmit(page) === false) {
                return false;
            }
        }

        function nextPage() {
            safeSubmit('next');
        }
        function prevPage() {
            if (paramData.branch_mode) {
                if (!window.confirm(langs.CONFIRM_BRANCH_ANSWER_BACK)) {
                    return false;
                }
            }
            if (safeSubmit('pre') === false)  {
                return false;
            }
        }
    </script>

    <title> - </title>
</head>
<body onload="javascript:formchanged()">
<div class="answer-form-container">
    <div class="answer-form">
        <!--function(n,e,r,i){return It(t,n,e,r,i,!0)}-->
        <form name="answer_form" method="POST" enctype="multipart/form-data" autocomplete="off"><input type="hidden" name="timer" value="1686844899"><input type="hidden" name="QstnSession[s]" value="1"><input type="hidden" name="page" value="1"><input type="hidden" name="pre_page" value="1"><input type="hidden" name="time_limit" value="0"><input type="hidden" name="set_auth_perm" value="user"><input type="hidden" name="button_url" value="dqstn_button.php?set_contents_id=962a571d4c0e807ac6c73650305a376a&amp;contents_name=%E7%AC%AC1%E5%9B%9E%E3%80%80%E7%94%9F%E5%91%BD%E7%A7%91%E5%AD%A6%E3%80%80%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%E3%80%80%E6%8F%90%E5%87%BA&amp;page=1&amp;end_page=1&amp;time_limit=0&amp;deadline=1687010459&amp;set_auth_perm=user&amp;enquete=7&amp;check_unanswered=&amp;check=&amp;ans=MA%3D%3D&amp;enable_bookmark=0&amp;language=JAPANESE&amp;timer=19&amp;label=&amp;utitle=5ZCJ55Sw44CA5pm06aaZ&amp;course_name=%E7%94%9F%E5%91%BD%E7%A7%91%E5%AD%A6%EF%BC%8F%E7%94%9F%E5%91%BD%E7%A7%91%E5%AD%A6%E3%81%AE%E5%9F%BA%E7%A4%8E+%282023-%E5%89%8D%E6%9C%9F-%E7%81%AB3%29+%5B%E6%B2%B3%E5%90%88%5D&amp;ch=bbe65d7bcffda727c95d345a69578acd&amp;acs_=1b767391#showhere"><input type="hidden" name="enquete" value="7"><input type="hidden" name="MAX_FILE_SIZE" value="1073741824"><input type="hidden" name="sendCmd"><input type="hidden" name="question_url" value="/webclass/loadit.php?lang=JAPANESE&amp;file=%2Fwebclass%2Fdata%2Fcourse%2F23%2F23N1100000021EL003%2Fc204ecbbafca090250a8ca8cdf70e5f2%2Fc204ecbbafca090250a8ca8cdf70e5f2.html"><table class="qstnoptions"><tbody><tr><td><table><tbody><tr><td data-state="empty" data-qnum="1" data-size-limit="10485760" data-type-limit="Word" class="d-and-d-upload"><!----> <div style="width: 100%;"><p>ファイルを指定するか、ここにファイルをドラッグアンドドロップしてください。</p><input type="file" name="report"><!----><p class="tips">最大アップロードファイルサイズ: <b>10 MB</b></p><p class="tips">指定された型式のファイルのみ受け付けます -&gt; <b>Word</b></p></div></td></tr></tbody></table></td></tr><tr><td class="point">( 0 )</td></tr></tbody></table>    <table id="QstnOperation">
        <tbody><tr>
            <td align="left" nowrap="">
                [前のページ]            </td>
            <td align="right" nowrap="">
                [次のページ]            </td>
        </tr>
        <tr>
            <td colspan="2" align="right">
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;             </td>
        </tr>
        <tr>
            <td align="right" colspan="2">
                <button id="GradeBtn" name="grade" type="button" onclick="gradeAndClose()">終了</button>            </td>
        </tr>
    </tbody></table>
</form>    </div>
</div>

<script src="./vendor.js.ダウンロード"></script>
<script src="./dqstn_answer.js.ダウンロード"></script>

</body></html>